package main

import "os"

type chip8 struct {
	memory           [4096]byte
	pc               uint16
	index            uint16
	registers        [16]uint8
	delayTimer       uint16
	instructionCount int
	sp               uint16
	stack            [128]uint16
	screen           []bool
	keys             [16]bool
	fontOffset       int
	largeFontOffset  int
	xLen             int
	yLen             int
	isHighRes        bool
	flagRegisters    [8]uint8
}

func newChip(file string) chip8 {
	chip := chip8{pc: 0x200}
	chip.setLowRes()
	font := []byte{
		0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
		0x20, 0x60, 0x20, 0x20, 0x70, // 1
		0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
		0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
		0x90, 0x90, 0xF0, 0x10, 0x10, // 4
		0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
		0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
		0xF0, 0x10, 0x20, 0x40, 0x40, // 7
		0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
		0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
		0xF0, 0x90, 0xF0, 0x90, 0x90, // A
		0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
		0xF0, 0x80, 0x80, 0x80, 0xF0, // C
		0xE0, 0x90, 0x90, 0x90, 0xE0, // D
		0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
		0xF0, 0x80, 0xF0, 0x80, 0x80, // F
	}

	chip.fontOffset = 0x50
	for i, v := range font {
		chip.memory[chip.fontOffset+i] = v
	}

	largeFont := []byte{
		0xC6, 0x7C, 0xDE, 0xCE, 0xF6, 0xD6, 0xC6, 0xE6, 0x00, 0x7C, // 0
		0x30, 0x10, 0x30, 0xF0, 0x30, 0x30, 0x30, 0x30, 0x00, 0xFC, // 1
		0xCC, 0x78, 0x0C, 0xCC, 0x30, 0x18, 0xCC, 0x60, 0x00, 0xFC, // 2
		0xCC, 0x78, 0x0C, 0x0C, 0x0C, 0x38, 0xCC, 0x0C, 0x00, 0x78, // 3
		0x1C, 0x0C, 0x6C, 0x3C, 0xFE, 0xCC, 0x0C, 0x0C, 0x00, 0x1E, // 4
		0xC0, 0xFC, 0xC0, 0xC0, 0x0C, 0xF8, 0xCC, 0x0C, 0x00, 0x78, // 5
		0x60, 0x38, 0xC0, 0xC0, 0xCC, 0xF8, 0xCC, 0xCC, 0x00, 0x78, // 6
		0xC6, 0xFE, 0x06, 0xC6, 0x18, 0x0C, 0x30, 0x30, 0x00, 0x30, // 7
		0xCC, 0x78, 0xEC, 0xCC, 0xDC, 0x78, 0xCC, 0xCC, 0x00, 0x78, // 8
		0xC6, 0x7C, 0xC6, 0xC6, 0x0C, 0x7E, 0x30, 0x18, 0x00, 0x70, // 9
		0x78, 0x30, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, 0x00, 0xCC, // A
		0x66, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x00, 0xFC, // B
		0x66, 0x3C, 0xC0, 0xC6, 0xC0, 0xC0, 0x66, 0xC6, 0x00, 0x3C, // C
		0x6C, 0xF8, 0x66, 0x66, 0x66, 0x66, 0x6C, 0x66, 0x00, 0xF8, // D
		0x62, 0xFE, 0x64, 0x60, 0x64, 0x7C, 0x62, 0x60, 0x00, 0xFE, // E
		0x66, 0xFE, 0x64, 0x62, 0x64, 0x7C, 0x60, 0x60, 0x00, 0xF0, // F
	}

	chip.largeFontOffset = 0x100
	for i, v := range largeFont {
		chip.memory[chip.largeFontOffset+i] = v
	}

	f, err := os.Open(file)
	if err != nil {
		panic(err)
	}
	_, err = f.Read(chip.memory[512:])
	if err != nil {
		panic(err)
	}

	return chip
}

func (c *chip8) setLowRes() {
	c.screen = make([]bool, 32*64)
	c.xLen = 64
	c.yLen = 32
	c.isHighRes = false
}

func (c *chip8) setHighRes() {
	c.screen = make([]bool, 64*128)
	c.xLen = 128
	c.yLen = 64
	c.isHighRes = true
}

func (c *chip8) clearScreen() {
	for i := 0; i < len(c.screen); i++ {
		c.screen[i] = false
	}
}
